@use '../../helpers/_mixins.scss' as mix;
@use '../../pages/Files/AllFiles/Files.scss' as *;

// Ensure profile menu has the highest z-index on all pages
.files-header {
  position: sticky !important;
  top: 0 !important;
  z-index: 9999999 !important; // Highest z-index for the entire header
  width: 100% !important;
  // CRITICAL: Don't create stacking context that blocks dropdown on mobile
  isolation: auto !important;
  
  @media (max-width: 768px) {
    isolation: auto !important;
    pointer-events: auto !important;
  }

  // Responsive container adjustments
  &__container {
    position: relative !important;
    
    // Extra small screens (< 640px)
    @media (max-width: 639px) {
      padding: 0 1rem !important;
    }

    @include mix.media-breakpoint-up(sm) {
      padding: 0 0.75rem !important;
    }

    @include mix.media-breakpoint-up(md) {
      padding: 0 1.5rem !important;
    }

    @include mix.media-breakpoint-up(lg) {
      padding: 0 2rem !important;
    }
  }

  // Responsive content layout
  &__content {
    position: relative !important;
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    justify-content: space-between !important;
    
    // Mobile: keep row layout but adjust padding
    @media (max-width: 639px) {
      padding: 0.625rem 0 !important;
      gap: 0.625rem !important;
    }

    // Desktop: row layout
    @include mix.media-breakpoint-up(sm) {
      padding: 1rem 0 !important;
      gap: 1rem !important;
    }

    @include mix.media-breakpoint-up(md) {
      padding: 1.25rem 0 !important;
      gap: 1.25rem !important;
    }

    @include mix.media-breakpoint-up(lg) {
      padding: 1.5rem 0 !important;
      gap: 1.5rem !important;
    }
  }

  // Responsive left section (logo + title)
  &__left {
    position: relative !important;
    display: flex !important;
    align-items: center !important;
    width: 100% !important;
    flex: 1 !important;
    min-width: 0 !important;
    
    // Extra small screens (< 640px)
    @media (max-width: 639px) {
      gap: 0.375rem !important;
    }

    @include mix.media-breakpoint-up(sm) {
      width: auto !important;
      gap: 0.625rem !important;
    }

    @include mix.media-breakpoint-up(md) {
      gap: 0.75rem !important;
    }
  }

  // Responsive logo icon
  &__icon {
    // Extra small screens (< 640px)
    @media (max-width: 639px) {
      width: 1.5rem !important;
      height: 1.5rem !important;
    }

    @include mix.media-breakpoint-up(sm) {
      width: 1.75rem !important;
      height: 1.75rem !important;
    }

    @include mix.media-breakpoint-up(md) {
      width: 2rem !important;
      height: 2rem !important;
    }

    @include mix.media-breakpoint-up(lg) {
      width: 2.25rem !important;
      height: 2.25rem !important;
    }
  }

  // Responsive title
  &__title {
    // Extra small screens (< 640px)
    @media (max-width: 639px) {
      font-size: 0.9375rem !important;
    }

    @include mix.media-breakpoint-up(sm) {
      font-size: 1.125rem !important;
    }

    @include mix.media-breakpoint-up(md) {
      font-size: 1.25rem !important;
    }

    @include mix.media-breakpoint-up(lg) {
      font-size: 1.375rem !important;
    }
  }

  // Responsive actions section
  &__actions {
    position: relative !important;
    display: flex !important;
    flex-direction: row !important; // Override column from Files.scss
    align-items: center !important;
    flex-shrink: 0 !important;
    width: auto !important; // Override 100% from Files.scss
    justify-content: flex-end !important;
    gap: 0.5rem !important;
    
    // Extra small screens (< 640px)
    @media (max-width: 639px) {
      gap: 0.375rem !important;
      justify-content: flex-end !important;
      flex-direction: row !important; // Keep row even on mobile
      width: auto !important;
      align-items: center !important; // Override stretch from Files.scss
    }

    @include mix.media-breakpoint-up(sm) {
      width: auto !important;
      gap: 0.5rem !important;
      flex-direction: row !important;
      align-items: center !important;
    }

    @include mix.media-breakpoint-up(md) {
      gap: 0.625rem !important;
      flex-direction: row !important;
      align-items: center !important;
    }
  }

  // Responsive profile button
  &__profile-button {
    position: relative !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    flex-shrink: 0 !important;
    
    // Extra small screens (< 640px)
    @media (max-width: 639px) {
      width: 2rem !important;
      height: 2rem !important;
    }

    @include mix.media-breakpoint-up(sm) {
      width: 2.5rem !important;
      height: 2.5rem !important;
    }

    @include mix.media-breakpoint-up(md) {
      width: 2.75rem !important;
      height: 2.75rem !important;
    }

    @include mix.media-breakpoint-up(lg) {
      width: 3rem !important;
      height: 3rem !important;
    }
  }

  &__profile-image {
    position: relative !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    flex-shrink: 0 !important;
    border-radius: 50% !important;
  }

  &__profile-placeholder {
    position: relative !important;
    width: 100% !important;
    height: 100% !important;
    flex-shrink: 0 !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  &__profile-menu {
    position: relative !important;
    z-index: 9999999 !important; // Highest z-index to appear above everything
    display: flex !important;
    align-items: center !important;
    isolation: auto !important; // Don't create stacking context that could trap dropdown
  }

  &__profile-backdrop {
    position: fixed !important;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999998 !important; // Just below dropdown
    pointer-events: auto !important;
    background: transparent !important;
    // CRITICAL: Don't create stacking context that blocks dropdown
    isolation: auto !important;
    // CRITICAL: Ensure backdrop doesn't block events to dropdown
    // The dropdown's higher z-index should allow it to receive events first
    touch-action: manipulation !important;
    
    // Show overlay in mobile view
    @include mix.media-breakpoint-down(md) {
      background: rgba(0, 0, 0, 0.3) !important;
      // CRITICAL: On mobile, backdrop should not block dropdown
      // Dropdown's higher z-index ensures it receives events first
      // JavaScript will handle checking if touch is on dropdown
      pointer-events: auto !important;
    }
  }

  &__profile-dropdown {
    position: fixed !important;
    z-index: 9999999 !important; // Highest z-index to appear above everything
    // DO NOT use isolation: isolate here - it creates a stacking context that hides the menu on mobile
    transform: translateZ(0); // Force hardware acceleration
    pointer-events: auto !important;
    touch-action: manipulation !important;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1) !important;
    -webkit-touch-callout: none !important;
    user-select: none !important;
    -webkit-user-select: none !important;
    isolation: auto !important; // CRITICAL: Don't create stacking context
    will-change: transform; // Optimize for transforms
    
    // Ensure all child elements (links, buttons) are clickable
    * {
      pointer-events: auto !important;
      touch-action: manipulation !important;
    }
    
    // Specifically ensure links are clickable
    a, button {
      pointer-events: auto !important;
      cursor: pointer !important;
      display: flex !important;
      width: 100% !important;
      touch-action: manipulation !important;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1) !important;
      position: relative !important;
      z-index: 1 !important;
    }

    // Responsive dropdown sizing
    // Extra small screens (< 640px)
    @media (max-width: 639px) {
      min-width: 160px !important;
      max-width: calc(100vw - 1rem) !important;
      font-size: 0.8125rem !important;
      isolation: auto !important; // Explicitly remove isolation on mobile
      pointer-events: auto !important;
      touch-action: manipulation !important;
      // CRITICAL: Ensure dropdown is above everything on mobile
      z-index: 9999999 !important;
      position: fixed !important;
      
      // Ensure all children are clickable
      * {
        pointer-events: auto !important;
        touch-action: manipulation !important;
      }
    }

    @include mix.media-breakpoint-up(sm) {
      min-width: 180px !important;
      max-width: calc(100vw - 2rem) !important;
    }

    @include mix.media-breakpoint-up(md) {
      min-width: 200px !important;
    }

    @include mix.media-breakpoint-up(lg) {
      min-width: 220px !important;
    }
    
    // Mobile-specific fixes to ensure dropdown works
    @include mix.media-breakpoint-down(md) {
      isolation: auto !important; // Remove isolation on mobile to prevent stacking context issues
      pointer-events: auto !important;
      touch-action: manipulation !important;
      z-index: 9999999 !important; // Ensure highest z-index on mobile
      position: fixed !important;
      
      // Force all interactive elements to be clickable
      a, button, [role="button"] {
        pointer-events: auto !important;
        touch-action: manipulation !important;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1) !important;
        cursor: pointer !important;
        position: relative !important;
        z-index: 2 !important;
      }
    }
  }

  // Responsive profile dropdown items
  &__profile-item {
    display: flex !important;
    align-items: center !important;
    gap: 0.75rem !important;
    padding: 0.875rem 1rem !important;
    color: var(--color-indigo-700) !important;
    text-decoration: none !important;
    font-size: 0.875rem !important;
    font-weight: 600 !important;
    transition: all 0.2s !important;
    border: none !important;
    background: none !important;
    width: 100% !important;
    text-align: left !important;
    cursor: pointer !important;
    pointer-events: auto !important;
    touch-action: manipulation !important;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1) !important;
    -webkit-touch-callout: none !important;
    user-select: none !important;
    -webkit-user-select: none !important;
    position: relative !important;
    z-index: 1 !important;
    
    // Ensure links are clickable (Link components have href attribute)
    &[href] {
      pointer-events: auto !important;
      cursor: pointer !important;
    }
    
    // Extra small screens (< 640px)
    @media (max-width: 639px) {
      padding: 0.75rem 0.875rem !important;
      font-size: 0.8125rem !important;
      min-height: 40px !important;
      touch-action: manipulation !important;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1) !important;
      cursor: pointer !important;
      user-select: none !important;
    }

    @include mix.media-breakpoint-up(sm) {
      padding: 0.875rem 1rem !important;
      font-size: 0.875rem !important;
      min-height: 44px !important;
    }
    
    &:hover {
      background: var(--color-indigo-100) !important;
      color: var(--color-indigo-800) !important;
    }
  }

  &__profile-item-icon {
    // Extra small screens (< 640px)
    @media (max-width: 639px) {
      width: 1rem !important;
      height: 1rem !important;
    }

    @include mix.media-breakpoint-up(sm) {
      width: 1.125rem !important;
      height: 1.125rem !important;
    }
  }
}

// CRITICAL FIX: Profile dropdown mobile interaction issues
// This fixes the non-responsive dropdown clicks on mobile devices

// 1. MOST IMPORTANT: Fix the backdrop to NOT block dropdown clicks
.files-header__profile-backdrop {
  // The backdrop should be BEHIND the dropdown, not blocking it
  pointer-events: none !important; // Don't capture any clicks
  
  @media (max-width: 768px) {
    // On mobile, only show visual overlay but don't block clicks
    pointer-events: none !important; // Let clicks pass through to dropdown
  }
}

// 2. Remove all isolation contexts that create stacking issues
.files-header {
  isolation: auto !important; // Don't create stacking context
  
  &__actions {
    isolation: auto !important;
    position: relative;
    z-index: auto; // Let children manage their own z-index
  }
  
  &__profile-menu {
    isolation: auto !important; // Critical: don't trap dropdown
    position: relative;
    z-index: auto; // Let dropdown manage its own z-index
  }
}

// 2. Fix backdrop to not interfere with dropdown clicks
.files-header__profile-backdrop {
  position: fixed !important;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9998 !important; // Below dropdown
  isolation: auto !important;
  pointer-events: none !important; // CRITICAL: Don't block clicks
  
  @media (max-width: 768px) {
    background: rgba(0, 0, 0, 0.3) !important;
    pointer-events: none !important; // Let clicks pass through
  }
}

// 3. Ensure dropdown is always on top and clickable
.files-header__profile-dropdown {
  position: fixed !important;
  z-index: 9999 !important; // Above backdrop
  isolation: auto !important; // CRITICAL: Don't create stacking context
  pointer-events: auto !important;
  touch-action: manipulation !important;
  
  // Force hardware acceleration for better mobile performance
  transform: translateZ(0);
  -webkit-transform: translateZ(0);
  will-change: transform;
  
  // Ensure all children receive pointer events
  * {
    pointer-events: auto !important;
    touch-action: manipulation !important;
  }
  
  // Make all interactive elements fully clickable
  a, 
  button, 
  [role="button"],
  [href] {
    pointer-events: auto !important;
    touch-action: manipulation !important;
    cursor: pointer !important;
    display: flex !important;
    width: 100% !important;
    position: relative !important;
    z-index: 1 !important;
    
    // Better touch feedback
    -webkit-tap-highlight-color: rgba(99, 102, 241, 0.2) !important;
    -webkit-touch-callout: none !important;
    user-select: none !important;
    -webkit-user-select: none !important;
  }
  
  // Mobile-specific overrides
  @media (max-width: 768px) {
    z-index: 9999 !important;
    isolation: auto !important; // Explicitly remove on mobile
    
    // Ensure minimum touch target size
    a, button {
      min-height: 44px !important;
      padding: 1rem !important;
    }
  }
}

// 4. Fix dropdown items to be fully interactive
.files-header__profile-item {
  pointer-events: auto !important;
  touch-action: manipulation !important;
  cursor: pointer !important;
  position: relative !important;
  z-index: 1 !important;
  
  // Remove any properties that might block clicks
  -webkit-tap-highlight-color: rgba(99, 102, 241, 0.2) !important;
  -webkit-touch-callout: none !important;
  user-select: none !important;
  -webkit-user-select: none !important;
  
  // Ensure link/button behavior
  display: flex !important;
  width: 100% !important;
  
  @media (max-width: 768px) {
    min-height: 44px !important;
    padding: 1rem !important;
  }
}

// 5. Ensure content doesn't block dropdown
.files-content,
.files-content * {
  // Content should be below dropdown
  position: relative;
  z-index: auto;
  
  @media (max-width: 768px) {
    // Ensure content doesn't create stacking context
    isolation: auto !important;
  }
}

// 6. Fix any grid/container stacking issues
.grid,
.files-grid,
[class*="grid"] {
  isolation: auto !important;
  
  @media (max-width: 768px) {
    // Remove any z-index that might interfere
    z-index: auto !important;
  }
}

// 7. Prevent file cards from blocking dropdown
.file-card,
.folder-card {
  z-index: 1 !important; // Keep low
  
  // Ensure dropdown menu inside cards is above card content
  .file-dropdown-menu {
    z-index: 50 !important; // Local stacking within card
  }
}

// 8. Global body fix when dropdown is open
body.profile-menu-open {
  // Prevent scrolling when menu is open on mobile
  @media (max-width: 768px) {
    overflow: hidden;
  }
  
  // Ensure dropdown is always on top
  .files-header__profile-dropdown {
    z-index: 9999 !important;
    isolation: auto !important;
  }
}

// 9. Fix for React Router Link components
.files-header__profile-dropdown {
  // Target Link components specifically
  a[href] {
    // Ensure React Router Links work
    text-decoration: none !important;
    color: inherit !important;
    
    // Make entire link area clickable
    &::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -1;
    }
  }
}

// 10. Remove any competing z-index contexts
.min-h-screen,
.revenue-referral-section,
.revenue-data-page {
  z-index: auto !important;
  isolation: auto !important;
  
  @media (max-width: 768px) {
    position: relative;
  }
}

// Extra small screens (phones in portrait < 360px)
@media (max-width: 360px) {
  .files-header {
    &__container {
      padding: 0 0.25rem !important;
    }

    &__content {
      padding: 0.5rem 0 !important;
      gap: 0.5rem !important;
      flex-direction: row !important;
      align-items: center !important;
      justify-content: space-between !important;
    }

    &__left {
      width: 100% !important;
    }

    &__actions {
      width: 100% !important;
      justify-content: flex-end !important;
    }

    &__icon {
      width: 1.25rem !important;
      height: 1.25rem !important;
    }

    &__title {
      font-size: 0.875rem !important;
    }

    &__profile-button {
      width: 1.75rem !important;
      height: 1.75rem !important;
    }

    &__profile-dropdown {
      min-width: 140px !important;
      font-size: 0.75rem !important;
    }

    &__profile-item {
      padding: 0.625rem 0.75rem !important;
      font-size: 0.75rem !important;
      min-height: 36px !important;
    }
  }
}


